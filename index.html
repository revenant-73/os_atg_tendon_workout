<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Daily Reset</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <style>
    :root {
      --bg: #0f0f10;
      --card-bg: #1a1a1c;
      --text: #f3f3f3;
      --accent: #1f5cff;
      --border: #2a2a2e;
      --muted: #a1a1a6;
      --radius: 14px;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
      line-height: 1.5;
    }
    header {
      position: sticky;
      top: 0;
      background: rgba(15, 15, 16, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 16px;
      z-index: 10;
    }
    h1 { margin: 0; font-size: 1.1rem; font-weight: 700; }
    .sub { color: var(--muted); font-size: 0.75rem; margin-top: 4px; }
    
    main { padding: 16px 16px 120px; max-width: 600px; margin: 0 auto; }
    
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .stack { display: flex; flex-direction: column; gap: 12px; }
    
    select, button, textarea {
      background: var(--card-bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      font-size: 1rem;
      font-family: inherit;
      appearance: none;
    }
    
    button {
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.1s, opacity 0.1s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 48px; /* Touch target */
    }
    button:active { transform: scale(0.98); opacity: 0.9; }
    button.primary { background: var(--accent); border-color: var(--accent); width: 100%; }
    button.ghost { background: transparent; border-color: transparent; color: var(--muted); }
    
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .muted { color: var(--muted); font-size: 0.85rem; }
    .pill {
      display: inline-block;
      padding: 6px 12px;
      background: #252528;
      border-radius: 99px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 480px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    
    textarea { width: 100%; min-height: 80px; resize: none; }
    
    .footerbar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(22, 22, 24, 0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid var(--border);
      padding: 16px 20px calc(16px + env(safe-area-inset-bottom));
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }
    .timer { font-variant-numeric: tabular-nums; font-size: 1.5rem; font-weight: 700; }
    
    label { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 100px; }
    
    /* Custom select arrow */
    .select-wrapper { position: relative; flex: 1; }
    .select-wrapper::after {
      content: "▼"; font-size: 10px; position: absolute; right: 12px; top: 50%;
      transform: translateY(-50%); pointer-events: none; color: var(--muted);
    }
    select { width: 100%; padding-right: 32px; }
    .exercise-card {
      background: #252528;
      border-radius: 12px;
      padding: 14px;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      border-left: 4px solid var(--accent);
    }
    .exercise-title { font-size: 0.9rem; font-weight: 600; color: var(--text); }
    .exercise-target { font-size: 1.1rem; font-weight: 800; color: var(--accent); }
    .exercise-note { font-size: 0.75rem; color: var(--muted); line-height: 1.3; }

    .phase-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin-top: 8px;
      margin-bottom: 4px;
      grid-column: 1 / -1;
    }
  </style>
</head>
<body>
<header>
  <h1>20-Min Reset + ATG + Tendons</h1>
  <div class="sub">8-week progressive plan • offline PWA • local-only data</div>
</header>

<main>
  <div class="card">
    <div class="stack">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="pill" id="blockPill">Block: —</span>
      </div>

      <div class="row">
        <label class="muted">Week
          <div class="select-wrapper">
            <select id="weekSel"></select>
          </div>
        </label>

        <label class="muted">Day
          <div class="select-wrapper">
            <select id="daySel">
              <option value="Mon">Mon</option><option value="Tue">Tue</option><option value="Wed">Wed</option>
              <option value="Thu">Thu</option><option value="Fri">Fri</option><option value="Sat">Sat</option><option value="Sun">Sun</option>
            </select>
          </div>
        </label>
      </div>

      <label class="muted">Readiness
        <div class="select-wrapper">
          <select id="readySel">
            <option value="green">Green</option>
            <option value="yellow">Yellow</option>
            <option value="red">Red</option>
          </select>
        </div>
      </label>

      <button class="primary" id="renderBtn">Show Today</button>
    </div>

    <div class="muted" style="margin-top:12px; font-size: 0.75rem; text-align: center;">
      Rule: nasal breathing. If breathing/posture breaks → scale back.
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 12px;font-size:14px; color: var(--muted);">Weekly Check-in</h2>
    <textarea id="weeklyNote" placeholder="One sentence: what feels safer, smoother, or stronger this week?"></textarea>
    <div class="row" style="margin-top:12px;">
      <button id="saveNoteBtn" style="flex: 1;">Save</button>
      <button class="ghost" id="clearNoteBtn">Clear</button>
    </div>
    <div id="noteStatus" class="muted" style="margin-top:8px; text-align: center; height: 1em;"></div>
  </div>

  <div id="planCard">
    <div class="card" style="text-align: center; padding: 40px 20px;">
      <h2 style="margin:0 0 8px;font-size:16px;">Today’s Plan</h2>
      <div class="muted">Pick Week + Day and tap “Show Today”.</div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 12px;font-size:14px; color: var(--muted);">Completion</h2>
    <div class="stack">
      <button id="markDoneBtn" class="primary" style="background: #22c55e; border-color: #22c55e;">Mark today done ✅</button>
      <button class="ghost" id="undoDoneBtn">Undo</button>
      <div id="doneStatus" class="muted" style="text-align: center; font-size: 0.75rem;"></div>
    </div>
  </div>
</main>

<div class="footerbar">
  <div style="flex: 1;">
    <div class="muted" style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em;">Timer</div>
    <div class="timer" id="timerText">00:00</div>
  </div>
  <div class="row" style="flex: 2; justify-content: flex-end;">
    <div class="select-wrapper" style="min-width: 80px;">
      <select id="timerPreset" style="padding: 8px 24px 8px 12px; font-size: 0.9rem; min-height: 40px;">
        <option value="30">30s</option>
        <option value="45">45s</option>
        <option value="60">60s</option>
        <option value="90">90s</option>
      </select>
    </div>
    <button id="startBtn" class="primary" style="width: auto; padding: 0 20px; min-height: 40px; background: var(--accent);">Start</button>
    <button id="stopBtn" class="ghost" style="min-height: 40px; padding: 0 10px;">Stop</button>
  </div>
</div>

<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }

  const KEY = "os_atg_tendon_pwa_v1";
  const state = JSON.parse(localStorage.getItem(KEY) || "{}");
  const saveState = () => localStorage.setItem(KEY, JSON.stringify(state));

  const weekSel = document.getElementById("weekSel");
  for (let i=1;i<=8;i++){
    const opt = document.createElement("option");
    opt.value = String(i); opt.textContent = `Week ${i}`;
    weekSel.appendChild(opt);
  }
  const daySel = document.getElementById("daySel");
  const readySel = document.getElementById("readySel");
  const blockPill = document.getElementById("blockPill");
  const planCard = document.getElementById("planCard");
  const weeklyNote = document.getElementById("weeklyNote");
  const noteStatus = document.getElementById("noteStatus");
  const doneStatus = document.getElementById("doneStatus");

  weekSel.value = state.week || "1";
  daySel.value = state.day || "Mon";
  readySel.value = state.readiness || "green";
  weeklyNote.value = (state.weeklyNotes && state.weeklyNotes[weekSel.value]) || "";

  function blockForWeek(w){
    w = Number(w);
    if (w<=2) return "Weeks 1–2: Restore & Map";
    if (w<=4) return "Weeks 3–4: Own the Range";
    if (w<=6) return "Weeks 5–6: Capacity Confirmation";
    return "Weeks 7–8: Integration & Expression";
  }

  function getPlan(week, day, readiness){
    const w = Number(week);
    const block = blockForWeek(w);

    const calfHold = (w<=2)?30 : (w<=4)?45 : (w<=6)?60 : 45;
    const splitIso = (w<=2)?30 : (w<=4)?40 : (w<=6)?60 : 30;
    const crawlDur = (w<=2)?30 : (w<=4)?60 : (w<=6)?90 : 60;

    const reset = [
      { phase: "Reset", title: "Supine Breathing", target: "5 breaths" },
      { phase: "Reset", title: "Neck Nods", target: "10–15 reps" },
      { phase: "Reset", title: "Rocking", target: "15–20 reps" },
      { phase: "Reset", title: "Rolling", target: "4–6 reps" },
    ];

    if (readiness === "red"){
      return { block, items: [...reset, { phase: "Note", title: "RED DAY", target: "Stop or Gentle Rocking", note: "Goal: finish calmer than you started." }] };
    }

    const tendons = [
      { phase: "Tendons", title: "Bent-Knee Calf ISO", target: `${calfHold}s x 2`, note: "Focus on tension" },
      { phase: "Tendons", title: "Tibialis Raises", target: "12–15 reps", note: "Or 20-30s ISO" },
      { phase: "Tendons", title: "Split Squat ISO", target: `${splitIso}s /side`, note: "Stay upright" },
    ];

    const days = {
      Mon: [
        { phase: "ATG", title: "ATG Split Squat", target: "2 x 5 /side", note: "Pause 3–5s at bottom" },
        { phase: "ATG", title: "Deep Squat Breathing", target: "5–8 breaths" },
        { phase: "Integrate", title: "Wall Sit", target: "45–60s" }
      ],
      Tue: [
        { phase: "Hip/Post", title: "Slow Hinges", target: "8–10 reps" },
        { phase: "Hip/Post", title: "Glute Bridge ISO", target: "30–45s" },
        { phase: "Hip/Post", title: "Hip Flexor Breathing", target: "45–60s /side" },
        { phase: "Integrate", title: "Bear Hold", target: "30–45s" }
      ],
      Wed: [
        { phase: "Lateral", title: "Lateral Lunge / Cossack", target: "4–6 /side" },
        { phase: "Lateral", title: "Side Plank", target: "30s /side" },
        { phase: "Integrate", title: "Lateral Crawl", target: "30–45s" }
      ],
      Thu: [
        { phase: "ISO Emphasis", title: "Split Squat ISO", target: "Quiet breathing" },
        { phase: "ISO Emphasis", title: "Calf ISO", target: "Solid tension" },
        { phase: "ISO Emphasis", title: "Tibialis ISO", target: "Hold strong" },
        { phase: "Integrate", title: "Easy Crawl", target: "45–60s + 5 breaths" }
      ],
      Fri: [
        { phase: "Flow", title: "Transitions", target: "10 mins", note: "Squat → hinge → crawl → stand (smooth)" },
        { phase: "Flow", title: "Partial Get-up", target: "Optional pattern" },
        { phase: "Finish", title: "Deep Squat Breathing", target: "3–5 min", note: "Or rocking" }
      ],
      Sat: [
        { phase: "Athletic", title: "Carry / Sled / March", target: "5–8 min", note: "Expression, not conditioning" },
        { phase: "Athletic", title: "Crawl Dose", target: `${crawlDur}s total` }
      ],
      Sun: [
        { phase: "Restore", title: "Full Routine", target: "15–20 min", note: "Breathing, rolling, rocking, easy crawling. Downshift." }
      ],
    };

    const items = [...reset, ...tendons, ...days[day]];

    if (w>=5 && w<=6 && day==="Mon"){
      items.push({ phase: "Signal", title: "STRENGTH SIGNAL", target: "60s ISO", note: "Wall sit OR Split Squat. Not to failure." });
    }

    items.push({ phase: "Crawl", title: "Total Crawl Dose", target: `${crawlDur}s`, note: "Somewhere in the session" });

    if (readiness === "yellow") {
      items.push({ phase: "Note", title: "YELLOW DAY", target: "Cut volume 50%", note: "Keep holds shorter, keep everything quiet." });
    }

    return { block, items };
  }

  function render(){
    const week = weekSel.value;
    const day = daySel.value;
    const readiness = readySel.value;

    state.week = week; state.day = day; state.readiness = readiness;
    saveState();

    const { block, items } = getPlan(week, day, readiness);
    blockPill.textContent = `Block: ${block}`;

    const id = `${week}-${day}`;
    const done = state.done && state.done[id];

    let lastPhase = "";
    const htmlItems = items.map(item => {
      let phaseHtml = "";
      if (item.phase !== lastPhase) {
        phaseHtml = `<div class="phase-label">${item.phase}</div>`;
        lastPhase = item.phase;
      }
      return `
        ${phaseHtml}
        <div class="exercise-card">
          <div class="exercise-title">${item.title}</div>
          <div class="exercise-target">${item.target}</div>
          ${item.note ? `<div class="exercise-note">${item.note}</div>` : ""}
        </div>
      `;
    }).join("");

    planCard.innerHTML = `
      <div class="card">
        <h2 style="margin:0 0 4px;font-size:1rem; font-weight:700;">Today’s Plan</h2>
        <div class="muted" style="margin-bottom:16px;">${day}, Week ${week} • Readiness: ${readiness.toUpperCase()}</div>
        <div class="grid">
          ${htmlItems}
        </div>
        ${done ? `<div style="margin-top:24px; text-align:center; color:#22c55e; font-weight:600; background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 10px;">✅ SESSION COMPLETE</div>` : ""}
      </div>
    `;

    weeklyNote.value = (state.weeklyNotes && state.weeklyNotes[week]) || "";
    doneStatus.textContent = done ? `Marked done for ${day} (Week ${week}).` : "";
  }

  document.getElementById("renderBtn").addEventListener("click", render);
  weekSel.addEventListener("change", render);
  daySel.addEventListener("change", render);
  readySel.addEventListener("change", render);

  document.getElementById("saveNoteBtn").addEventListener("click", () => {
    const w = weekSel.value;
    state.weeklyNotes = state.weeklyNotes || {};
    state.weeklyNotes[w] = weeklyNote.value.trim();
    saveState();
    noteStatus.textContent = `Saved for Week ${w}.`;
    setTimeout(()=>noteStatus.textContent="", 1200);
  });

  document.getElementById("clearNoteBtn").addEventListener("click", () => { weeklyNote.value = ""; });

  document.getElementById("markDoneBtn").addEventListener("click", () => {
    const id = `${weekSel.value}-${daySel.value}`;
    state.done = state.done || {};
    state.done[id] = true;
    saveState();
    render();
  });

  document.getElementById("undoDoneBtn").addEventListener("click", () => {
    const id = `${weekSel.value}-${daySel.value}`;
    if (state.done) delete state.done[id];
    saveState();
    render();
  });

  let timer = null, remaining = 0;
  const timerText = document.getElementById("timerText");
  const fmt = (s)=>`${String(Math.floor(s/60)).padStart(2,"0")}:${String(s%60).padStart(2,"0")}`;

  function tick(){
    remaining--;
    timerText.textContent = fmt(remaining);
    if (remaining <= 0){
      clearInterval(timer); timer=null;
      try { navigator.vibrate && navigator.vibrate([150,80,150]); } catch(e){}
      alert("Done.");
    }
  }

  document.getElementById("startBtn").addEventListener("click", () => {
    const preset = Number(document.getElementById("timerPreset").value);
    if (timer) clearInterval(timer);
    remaining = preset;
    timerText.textContent = fmt(remaining);
    timer = setInterval(tick, 1000);
  });

  document.getElementById("stopBtn").addEventListener("click", () => {
    if (timer) clearInterval(timer);
    timer = null;
  });

  render();
</script>
</body>
</html>
